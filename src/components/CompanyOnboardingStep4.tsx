import { useState, useRef, useEffect } from 'react';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Camera, MapPin } from 'lucide-react';

interface UserProfile {
  professionalTitle: string;
  profilePhoto?: File | null;
  country: string;
  city: string;
  phoneNumber: string;
  countryCode: string;
  linkedinUrl: string;
}

interface CompanyOnboardingStep4Props {
  onComplete: (data: UserProfile) => void;
  initialData: UserProfile;
  onProfileChange: (profile: UserProfile) => void;
  onProfilePhotoChange: (photo: File | null) => void;
}

const CompanyOnboardingStep4 = ({ 
  onComplete, 
  initialData, 
  onProfileChange, 
  onProfilePhotoChange 
}: CompanyOnboardingStep4Props) => {
  const [professionalTitle, setProfessionalTitle] = useState(initialData.professionalTitle || '');
  const [profilePhoto, setProfilePhoto] = useState<File | null>(initialData.profilePhoto || null);
  const [profilePhotoPreview, setProfilePhotoPreview] = useState<string | null>(null);
  const [country, setCountry] = useState(initialData.country || '');
  const [city, setCity] = useState(initialData.city || '');
  const [phoneNumber, setPhoneNumber] = useState(initialData.phoneNumber || '');
  const [countryCode, setCountryCode] = useState(initialData.countryCode || '+57');
  const [linkedinUrl, setLinkedinUrl] = useState(initialData.linkedinUrl || '');
  const [showLocationSuggestions, setShowLocationSuggestions] = useState(false);
  const [locationSuggestions, setLocationSuggestions] = useState<string[]>([]);
  const fileInputRef = useRef<HTMLInputElement>(null);
  const locationRef = useRef<HTMLDivElement>(null);

  // Pa√≠ses de LATAM, USA y Espa√±a con c√≥digos y banderas
  const latinAmericaCountries = [
    { code: '+57', country: 'Colombia', flag: 'üá®üá¥' },
    { code: '+52', country: 'M√©xico', flag: 'üá≤üáΩ' },
    { code: '+54', country: 'Argentina', flag: 'üá¶üá∑' },
    { code: '+56', country: 'Chile', flag: 'üá®üá±' },
    { code: '+51', country: 'Per√∫', flag: 'üáµüá™' },
    { code: '+593', country: 'Ecuador', flag: 'üá™üá®' },
    { code: '+58', country: 'Venezuela', flag: 'üáªüá™' },
    { code: '+506', country: 'Costa Rica', flag: 'üá®üá∑' },
    { code: '+507', country: 'Panam√°', flag: 'üáµüá¶' },
    { code: '+502', country: 'Guatemala', flag: 'üá¨üáπ' },
    { code: '+598', country: 'Uruguay', flag: 'üá∫üáæ' },
    { code: '+595', country: 'Paraguay', flag: 'üáµüáæ' },
    { code: '+591', country: 'Bolivia', flag: 'üáßüá¥' },
    { code: '+504', country: 'Honduras', flag: 'üá≠üá≥' },
    { code: '+503', country: 'El Salvador', flag: 'üá∏üáª' },
    { code: '+505', country: 'Nicaragua', flag: 'üá≥üáÆ' },
    { code: '+1-809', country: 'Rep√∫blica Dominicana', flag: 'üá©üá¥' },
    { code: '+53', country: 'Cuba', flag: 'üá®üá∫' },
    { code: '+1-787', country: 'Puerto Rico', flag: 'üáµüá∑' },
    { code: '+1', country: 'Estados Unidos', flag: 'üá∫üá∏' },
    { code: '+34', country: 'Espa√±a', flag: 'üá™üá∏' }
  ];

  // Lista solo de pa√≠ses para el selector de pa√≠s
  const countryNames = latinAmericaCountries.map(item => item.country);

  // Ciudades principales de LATAM
  const latinAmericaCities = [
    // Colombia
    'Bogot√°, Cundinamarca, Colombia',
    'Medell√≠n, Antioquia, Colombia',
    'Cali, Valle del Cauca, Colombia',
    'Barranquilla, Atl√°ntico, Colombia',
    'Cartagena, Bol√≠var, Colombia',
    'Bucaramanga, Santander, Colombia',
    'Pereira, Risaralda, Colombia',
    'Manizales, Caldas, Colombia',
    'Santa Marta, Magdalena, Colombia',
    'Ibagu√©, Tolima, Colombia',
    
    // M√©xico
    'Ciudad de M√©xico, CDMX, M√©xico',
    'Guadalajara, Jalisco, M√©xico',
    'Monterrey, Nuevo Le√≥n, M√©xico',
    'Puebla, Puebla, M√©xico',
    'Tijuana, Baja California, M√©xico',
    'Le√≥n, Guanajuato, M√©xico',
    'Ju√°rez, Chihuahua, M√©xico',
    'Zapopan, Jalisco, M√©xico',
    'M√©rida, Yucat√°n, M√©xico',
    'Canc√∫n, Quintana Roo, M√©xico',
    
    // Argentina
    'Buenos Aires, Buenos Aires, Argentina',
    'C√≥rdoba, C√≥rdoba, Argentina',
    'Rosario, Santa Fe, Argentina',
    'Mendoza, Mendoza, Argentina',
    'La Plata, Buenos Aires, Argentina',
    'Mar del Plata, Buenos Aires, Argentina',
    'Salta, Salta, Argentina',
    'Tucum√°n, Tucum√°n, Argentina',
    
    // Chile
    'Santiago, Regi√≥n Metropolitana, Chile',
    'Valpara√≠so, Valpara√≠so, Chile',
    'Concepci√≥n, Biob√≠o, Chile',
    'Antofagasta, Antofagasta, Chile',
    'Vi√±a del Mar, Valpara√≠so, Chile',
    'Temuco, La Araucan√≠a, Chile',
    
    // Per√∫
    'Lima, Lima, Per√∫',
    'Arequipa, Arequipa, Per√∫',
    'Trujillo, La Libertad, Per√∫',
    'Chiclayo, Lambayeque, Per√∫',
    'Piura, Piura, Per√∫',
    'Cusco, Cusco, Per√∫',
    
    // Ecuador
    'Quito, Pichincha, Ecuador',
    'Guayaquil, Guayas, Ecuador',
    'Cuenca, Azuay, Ecuador',
    'Machala, El Oro, Ecuador',
    
    // Venezuela
    'Caracas, Distrito Capital, Venezuela',
    'Maracaibo, Zulia, Venezuela',
    'Valencia, Carabobo, Venezuela',
    'Barquisimeto, Lara, Venezuela',
    
    // Costa Rica
    'San Jos√©, San Jos√©, Costa Rica',
    'Cartago, Cartago, Costa Rica',
    'Puntarenas, Puntarenas, Costa Rica',
    
    // Panam√°
    'Ciudad de Panam√°, Panam√°, Panam√°',
    'San Miguelito, Panam√°, Panam√°',
    'Tocumen, Panam√°, Panam√°',
    
    // Guatemala
    'Ciudad de Guatemala, Guatemala, Guatemala',
    'Mixco, Guatemala, Guatemala',
    'Villa Nueva, Guatemala, Guatemala',
    
    // Uruguay
    'Montevideo, Montevideo, Uruguay',
    'Salto, Salto, Uruguay',
    'Paysand√∫, Paysand√∫, Uruguay',
    
    // Paraguay
    'Asunci√≥n, Central, Paraguay',
    'Ciudad del Este, Alto Paran√°, Paraguay',
    'San Lorenzo, Central, Paraguay',
    
    // Bolivia
    'La Paz, La Paz, Bolivia',
    'Santa Cruz, Santa Cruz, Bolivia',
    'Cochabamba, Cochabamba, Bolivia',
    
    // Honduras
    'Tegucigalpa, Francisco Moraz√°n, Honduras',
    'San Pedro Sula, Cort√©s, Honduras',
    'Choloma, Cort√©s, Honduras',
    
    // El Salvador
    'San Salvador, San Salvador, El Salvador',
    'Santa Ana, Santa Ana, El Salvador',
    'San Miguel, San Miguel, El Salvador',
    
    // Nicaragua
    'Managua, Managua, Nicaragua',
    'Le√≥n, Le√≥n, Nicaragua',
    'Granada, Granada, Nicaragua',
    
    // Rep√∫blica Dominicana
    'Santo Domingo, Distrito Nacional, Rep√∫blica Dominicana',
    'Santiago, Santiago, Rep√∫blica Dominicana',
    'La Romana, La Romana, Rep√∫blica Dominicana',
    
    // Cuba
    'La Habana, La Habana, Cuba',
    'Santiago de Cuba, Santiago de Cuba, Cuba',
    'Camag√ºey, Camag√ºey, Cuba',
    
    // Puerto Rico
    'San Juan, San Juan, Puerto Rico',
    'Bayam√≥n, Bayam√≥n, Puerto Rico',
    'Carolina, Carolina, Puerto Rico',
    
    // Estados Unidos
    'Nueva York, Nueva York, Estados Unidos',
    'Los √Ångeles, California, Estados Unidos',
    'Chicago, Illinois, Estados Unidos',
    'Houston, Texas, Estados Unidos',
    'Phoenix, Arizona, Estados Unidos',
    'Philadelphia, Pennsylvania, Estados Unidos',
    'San Antonio, Texas, Estados Unidos',
    'San Diego, California, Estados Unidos',
    'Dallas, Texas, Estados Unidos',
    'San Jos√©, California, Estados Unidos',
    'Austin, Texas, Estados Unidos',
    'Jacksonville, Florida, Estados Unidos',
    'Fort Worth, Texas, Estados Unidos',
    'Columbus, Ohio, Estados Unidos',
    'Charlotte, North Carolina, Estados Unidos',
    'San Francisco, California, Estados Unidos',
    'Indianapolis, Indiana, Estados Unidos',
    'Seattle, Washington, Estados Unidos',
    'Denver, Colorado, Estados Unidos',
    'Boston, Massachusetts, Estados Unidos',
    'El Paso, Texas, Estados Unidos',
    'Detroit, Michigan, Estados Unidos',
    'Nashville, Tennessee, Estados Unidos',
    'Portland, Oregon, Estados Unidos',
    'Memphis, Tennessee, Estados Unidos',
    'Oklahoma City, Oklahoma, Estados Unidos',
    'Las Vegas, Nevada, Estados Unidos',
    'Louisville, Kentucky, Estados Unidos',
    'Baltimore, Maryland, Estados Unidos',
    'Milwaukee, Wisconsin, Estados Unidos',
    'Albuquerque, New Mexico, Estados Unidos',
    'Tucson, Arizona, Estados Unidos',
    'Fresno, California, Estados Unidos',
    'Sacramento, California, Estados Unidos',
    'Mesa, Arizona, Estados Unidos',
    'Kansas City, Missouri, Estados Unidos',
    'Atlanta, Georgia, Estados Unidos',
    'Long Beach, California, Estados Unidos',
    'Colorado Springs, Colorado, Estados Unidos',
    'Raleigh, North Carolina, Estados Unidos',
    'Miami, Florida, Estados Unidos',
    'Virginia Beach, Virginia, Estados Unidos',
    'Omaha, Nebraska, Estados Unidos',
    'Oakland, California, Estados Unidos',
    'Minneapolis, Minnesota, Estados Unidos',
    'Tulsa, Oklahoma, Estados Unidos',
    'Arlington, Texas, Estados Unidos',
    'New Orleans, Louisiana, Estados Unidos',
    'Wichita, Kansas, Estados Unidos',
    
    // Espa√±a
    'Madrid, Comunidad de Madrid, Espa√±a',
    'Barcelona, Catalu√±a, Espa√±a',
    'Valencia, Comunidad Valenciana, Espa√±a',
    'Sevilla, Andaluc√≠a, Espa√±a',
    'Zaragoza, Arag√≥n, Espa√±a',
    'M√°laga, Andaluc√≠a, Espa√±a',
    'Murcia, Regi√≥n de Murcia, Espa√±a',
    'Palma, Islas Baleares, Espa√±a',
    'Las Palmas de Gran Canaria, Canarias, Espa√±a',
    'Bilbao, Pa√≠s Vasco, Espa√±a',
    'Alicante, Comunidad Valenciana, Espa√±a',
    'C√≥rdoba, Andaluc√≠a, Espa√±a',
    'Valladolid, Castilla y Le√≥n, Espa√±a',
    'Vigo, Galicia, Espa√±a',
    'Gij√≥n, Asturias, Espa√±a',
    'L\'Hospitalet de Llobregat, Catalu√±a, Espa√±a',
    'Granada, Andaluc√≠a, Espa√±a',
    'Vitoria-Gasteiz, Pa√≠s Vasco, Espa√±a',
    'A Coru√±a, Galicia, Espa√±a',
    'Elche, Comunidad Valenciana, Espa√±a',
    'Oviedo, Asturias, Espa√±a',
    'Santa Cruz de Tenerife, Canarias, Espa√±a',
    'Badalona, Catalu√±a, Espa√±a',
    'Cartagena, Regi√≥n de Murcia, Espa√±a',
    'Terrassa, Catalu√±a, Espa√±a',
    'Jerez de la Frontera, Andaluc√≠a, Espa√±a',
    'Sabadell, Catalu√±a, Espa√±a',
    'M√≥stoles, Comunidad de Madrid, Espa√±a',
    'Alcal√° de Henares, Comunidad de Madrid, Espa√±a',
    'Pamplona, Navarra, Espa√±a',
    'Fuenlabrada, Comunidad de Madrid, Espa√±a',
    'Almer√≠a, Andaluc√≠a, Espa√±a',
    'Legan√©s, Comunidad de Madrid, Espa√±a'
  ];

  useEffect(() => {
    if (profilePhoto) {
      const reader = new FileReader();
      reader.onload = (e) => {
        setProfilePhotoPreview(e.target?.result as string);
      };
      reader.readAsDataURL(profilePhoto);
    } else {
      setProfilePhotoPreview(null);
    }
  }, [profilePhoto]);

  useEffect(() => {
    const profile = {
      professionalTitle,
      profilePhoto,
      country,
      city,
      phoneNumber,
      countryCode,
      linkedinUrl
    };
    onProfileChange(profile);
  }, [professionalTitle, profilePhoto, country, city, phoneNumber, countryCode, linkedinUrl, onProfileChange]);

  // Manejar clicks fuera del dropdown de ubicaci√≥n
  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (locationRef.current && !locationRef.current.contains(event.target as Node)) {
        setShowLocationSuggestions(false);
      }
    };

    document.addEventListener('mousedown', handleClickOutside);
    return () => {
      document.removeEventListener('mousedown', handleClickOutside);
    };
  }, []);

  const handleFileSelect = (event: React.ChangeEvent<HTMLInputElement>) => {
    const file = event.target.files?.[0];
    if (file) {
      setProfilePhoto(file);
      onProfilePhotoChange(file);
    }
  };

  const handleProfessionalTitleChange = (value: string) => {
    setProfessionalTitle(value);
  };

  const handleCountryChange = (value: string) => {
    setCountry(value);
    
    // Buscar el c√≥digo de pa√≠s correspondiente y actualizarlo autom√°ticamente
    const countryData = latinAmericaCountries.find(item => item.country === value);
    if (countryData) {
      setCountryCode(countryData.code);
    }
  };

  // Funci√≥n para buscar ciudades
  const searchLocations = (query: string) => {
    if (query.length < 2) {
      setLocationSuggestions([]);
      return;
    }
    
    const filtered = latinAmericaCities.filter(city =>
      city.toLowerCase().includes(query.toLowerCase())
    );
    setLocationSuggestions(filtered.slice(0, 5));
  };

  const handleLocationChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const value = e.target.value;
    setCity(value);
    searchLocations(value);
    setShowLocationSuggestions(true);
  };

  const handleLocationSelect = (selectedLocation: string) => {
    setCity(selectedLocation);
    setShowLocationSuggestions(false);
    setLocationSuggestions([]);
  };


  const handlePhoneChange = (value: string) => {
    setPhoneNumber(value);
  };

  const handleCountryCodeChange = (value: string) => {
    setCountryCode(value);
  };

  const handleLinkedinChange = (value: string) => {
    setLinkedinUrl(value);
  };

  // Validar si el formulario est√° completo (todos los campos obligatorios excepto LinkedIn)
  const isFormValid = 
    professionalTitle.trim().length > 0 &&
    country.trim().length > 0 &&
    city.trim().length > 0 &&
    phoneNumber.trim().length > 0 &&
    countryCode.trim().length > 0;

  const handleContinue = () => {
    if (!isFormValid) return;
    
    onComplete({
      professionalTitle,
      profilePhoto,
      country,
      city,
      phoneNumber,
      countryCode,
      linkedinUrl
    });
  };

  return (
    <div className="w-full mx-auto px-6 py-4 sm:px-8 sm:py-6 lg:px-12 lg:py-8 space-y-6 sm:space-y-7 lg:space-y-8 font-['Inter']">
      {/* Step Indicator */}
      <div className="text-center">
        <p className="text-sm text-gray-500 font-['Inter']">Perfil del Usuario (4/4)</p>
      </div>

      {/* Title and Description */}
      <div className="text-center space-y-3">
        <h1 className="font-bold text-gray-900 font-['Inter']" style={{fontSize: '24px'}}>
          Mostr√° qui√©n sos a tu equipo y al talento
        </h1>
        <p className="text-gray-600 font-['Inter']" style={{fontSize: '14px'}}>
          Tu puesto en la empresa
        </p>
        <p className="text-sm text-gray-500 font-['Inter']">
          Los campos marcados con <span className="text-red-500">*</span> son obligatorios
        </p>
      </div>

      {/* Form */}
      <div className="space-y-6">
        {/* Professional Title */}
        <div>
          <h2 className="font-medium text-gray-900 mb-3 font-['Inter']" style={{fontSize: '16px'}}>
            ¬øQu√© haces? <span className="text-red-500">*</span>
          </h2>
          <Input
            type="text"
            value={professionalTitle}
            onChange={(e) => handleProfessionalTitleChange(e.target.value)}
            className="h-12 text-base border border-gray-300 rounded-lg px-4 focus:border-gray-400 focus:ring-0 font-['Inter']"
            placeholder="Ej: Product Manager, CEO, Desarrollador..."
          />
        </div>

        {/* Profile Photo */}
        <div className="text-center">
          <h2 className="font-medium text-gray-900 mb-3 font-['Inter']" style={{fontSize: '16px'}}>
            Sube tu foto perfil
          </h2>
          {profilePhotoPreview ? (
            <div className="mb-4 space-y-3">
              <div className="w-20 h-20 mx-auto rounded-full overflow-hidden bg-gray-100 flex items-center justify-center">
                <img 
                  src={profilePhotoPreview} 
                  alt="Profile preview" 
                  className="w-full h-full object-cover"
                />
              </div>
              <Button
                type="button"
                variant="outline"
                onClick={() => fileInputRef.current?.click()}
                className="px-6 py-2 border border-gray-300 rounded-lg text-gray-600 hover:border-gray-400 font-['Inter']"
                style={{fontSize: '14px'}}
              >
                <Camera className="w-4 h-4 mr-2" />
                Cambiar foto
              </Button>
            </div>
          ) : (
            <div className="mb-4">
              <Button
                type="button"
                variant="outline"
                onClick={() => fileInputRef.current?.click()}
                className="px-8 py-3 border-2 border-gray-300 rounded-full text-gray-600 hover:border-gray-400 font-['Inter']"
                style={{fontSize: '14px'}}
              >
                <Camera className="w-4 h-4 mr-2" />
                Sube tu foto perfil
              </Button>
            </div>
          )}
          <input
            type="file"
            ref={fileInputRef}
            onChange={handleFileSelect}
            className="hidden"
            accept="image/*"
          />
        </div>

        {/* Country */}
        <div>
          <h2 className="font-medium text-gray-900 mb-3 font-['Inter']" style={{fontSize: '16px'}}>
            Pa√≠s <span className="text-red-500">*</span>
          </h2>
          <Select value={country} onValueChange={handleCountryChange}>
            <SelectTrigger className="h-12 text-base border border-gray-300 rounded-lg px-4 focus:border-gray-400 focus:ring-0 font-['Inter']">
              <SelectValue placeholder="Selecciona tu pa√≠s" />
            </SelectTrigger>
            <SelectContent>
              {countryNames.map((countryOption) => (
                <SelectItem key={countryOption} value={countryOption} className="font-['Inter']">
                  {countryOption}
                </SelectItem>
              ))}
            </SelectContent>
          </Select>
        </div>

        {/* City */}
        <div ref={locationRef}>
          <h2 className="font-medium text-gray-900 mb-3 font-['Inter']" style={{fontSize: '16px'}}>
            Ciudad <span className="text-red-500">*</span>
          </h2>
          <div className="relative">
            <div className="relative">
              <MapPin className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5" />
              <Input
                type="text"
                value={city}
                onChange={handleLocationChange}
                placeholder="Ej: Cali, Valle del Cauca, Colombia"
                className="h-12 pl-10 pr-4 text-base border border-gray-300 rounded-lg focus:border-gray-400 focus:ring-0 font-['Inter']"
              />
            </div>
            {showLocationSuggestions && locationSuggestions.length > 0 && (
              <div className="absolute z-10 w-full mt-1 bg-white border border-gray-200 rounded-lg shadow-lg max-h-60 overflow-y-auto">
                {locationSuggestions.map((location, index) => (
                  <div
                    key={index}
                    className="px-4 py-3 hover:bg-gray-50 cursor-pointer border-b border-gray-100 last:border-b-0"
                    onClick={() => handleLocationSelect(location)}
                  >
                    <div className="flex items-center space-x-3">
                      <MapPin className="w-4 h-4 text-gray-400 flex-shrink-0" />
                      <span className="text-sm text-gray-700 font-['Inter']">{location}</span>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
        </div>

        {/* Phone */}
        <div>
          <h2 className="font-medium text-gray-900 mb-3 font-['Inter']" style={{fontSize: '16px'}}>
            Tel√©fono <span className="text-red-500">*</span>
          </h2>
          <div className="flex gap-3">
            {/* Country Code Selector */}
            <Select value={countryCode} onValueChange={handleCountryCodeChange}>
              <SelectTrigger className="h-12 w-32 text-base border border-gray-300 rounded-lg px-4 focus:border-gray-400 focus:ring-0 font-['Inter']">
                <SelectValue />
              </SelectTrigger>
              <SelectContent>
                {latinAmericaCountries.map((item) => (
                  <SelectItem key={item.code} value={item.code} className="font-['Inter']">
                    <div className="flex items-center gap-2">
                      <span>{item.flag}</span>
                      <span>{item.code}</span>
                    </div>
                  </SelectItem>
                ))}
              </SelectContent>
            </Select>
            
            {/* Phone Number Input */}
            <Input
              type="tel"
              value={phoneNumber}
              onChange={(e) => handlePhoneChange(e.target.value)}
              className="h-12 flex-1 text-base border border-gray-300 rounded-lg px-4 focus:border-gray-400 focus:ring-0 font-['Inter']"
              placeholder="300 123 4567"
            />
          </div>
        </div>

        {/* LinkedIn */}
        <div>
          <h2 className="font-medium text-gray-900 mb-3 font-['Inter']" style={{fontSize: '16px'}}>
            Link a tu LinkedIn u otra red profesional (opcional)
          </h2>
          <Input
            type="url"
            value={linkedinUrl}
            onChange={(e) => handleLinkedinChange(e.target.value)}
            className="h-12 text-base border border-gray-300 rounded-lg px-4 focus:border-gray-400 focus:ring-0 font-['Inter']"
            placeholder="https://linkedin.com/in/tu-perfil"
          />
        </div>

        {/* Continue Button */}
        <div className="pt-6 pb-4">
          <Button
            onClick={handleContinue}
            disabled={!isFormValid}
            className={`w-full h-12 font-medium rounded-lg transition-colors font-['Inter'] ${
              isFormValid 
                ? 'bg-black hover:bg-gray-800 text-white' 
                : 'bg-gray-300 text-gray-500 cursor-not-allowed'
            }`}
            style={{fontSize: '14px'}}
          >
            Comenzar üöÄ
          </Button>
        </div>
      </div>
    </div>
  );
};

export default CompanyOnboardingStep4;
